<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

  <!-- Load TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"> </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>

  <script>
    function hasGetUserMedia() {
      return (navigator.getUserMedia || navigator.webkitGetUserMedia ||
        navigator.mozGetUserMedia || navigator.msGetUserMedia);
    }

    if (hasGetUserMedia()) {
      tf.loadLayersModel('https://raw.githubusercontent.com/khvmaths/khvmaths.github.io/master/model.json')
        .then(function (model) {
          console.log(model)
          const webrtcElement = document.getElementById("gum-local");
          window.requestAnimationFrame(onFrame.bind(null, model, webrtcElement));
        })
    }
    // const model = await tf.loadModel('localstorage://model.json');
    // const webrtcElement = document.getElementById("gum-local");
    // window.requestAnimationFrame(onFrame.bind(null, model, webrtcElement));

    /////////////HighChart/////////////////
    window.onload=function(){
    var ctx = document.getElementById('myChart');

    var myChart = new Chart(ctx, {
      type: 'horizontalBar',
      data: {
        labels:['A','B','C'],
        datasets: [{
          data: [0,0,0],
          
          backgroundColor: [
            'rgba(255, 99, 132, 0.2)',
            'rgba(54, 162, 235, 0.2)',
            'rgba(255, 206, 86, 0.2)'
          ],
          borderColor: [
            'rgba(255, 99, 132, 1)',
            'rgba(54, 162, 235, 1)',
            'rgba(255, 206, 86, 1)'
          ],
          borderWidth: 2
        }]
      },
      options: {
        scales: {
          yAxes: [{
            ticks: {
              beginAtZero: true,
              min:0,
              max:1
            }
          }]
        },
        legend: {
          display: false
        }
      },
      responsive: true
    });
    }

    function addData(chart, label, data) {
      chart.data.labels.push(label);
      chart.data.datasets.forEach((dataset) => {
        dataset.data.push(data);
      });
      chart.update();
    }

    function removeData(chart) {
      chart.data.labels.pop();
      chart.data.datasets.forEach((dataset) => {
        dataset.data.pop();
      });
      chart.update();
    }

    function onFrame(model, webrtcElement) {
      if (document.getElementById("gum-local").readyState === 4) {
        const tensor = tf.browser.fromPixels(webrtcElement);
        const eTensor = tensor.expandDims(0).asType('float32').div(256.0);
        const pred = model.predict(eTensor)
        var readable_output = pred.dataSync();
        console.log(readable_output);
        removeData(myChart);
        addData(myChart, 'A', readable_output[0]);
        addData(myChart, 'B', readable_output[1]);
        addData(myChart, 'C', readable_output[2]);
        // console.log(max)
        // const index = max.get([0])
        const label = 'Ripe'
        const labelElement = document.getElementById("label");
        labelElement.innerHTML = label

        window.requestAnimationFrame(onFrame.bind(null, model, webrtcElement));
      }
    }


    /////////////////
    // WEBRTC

    // Put variables in global scope to make them available to the browser console.
    const constraints = window.constraints = {
      audio: false,
      video: {
        facingMode: 'environment',
        width: 300,
        height: 300
      }
    };

    function handleSuccess(stream) {
      const video = document.querySelector('video');
      const videoTracks = stream.getVideoTracks();
      console.log('Got stream with constraints:', constraints);
      console.log(`Using video device: ${videoTracks[0].label}`);
      window.stream = stream; // make variable available to browser console
      video.srcObject = stream;
    }

    function handleError(error) {
      if (error.name === 'ConstraintNotSatisfiedError') {
        let v = constraints.video;
        errorMsg(`The resolution ${v.width.exact}x${v.height.exact} px is not supported by your device.`);
      } else if (error.name === 'PermissionDeniedError') {
        errorMsg('Permissions have not been granted to use your camera and ' +
          'microphone, you need to allow the page access to your devices in ' +
          'order for the demo to work.');
      }
      errorMsg(`getUserMedia error: ${error.name}`, error);
    }

    function errorMsg(msg, error) {
      const errorElement = document.querySelector('#errorMsg');
      errorElement.innerHTML += `<p>${msg}</p>`;
      if (typeof error !== 'undefined') {
        console.error(error);
      }
    }

    navigator.mediaDevices
      .getUserMedia(constraints)
      .then(handleSuccess)
      .catch(handleError);
  </script>
</head>

<body>
  <div class="container fluid">
    <div class="row">
      <div class="col">
        <video id="gum-local" width="500" height="500" autoPlay playsinline></video>
      </div>
      <div class="row">
        <div class="col">
          <canvas id="myChart" width="500" height="200"></canvas>
          <!--<div id="label"></div>-->
        </div>
        <div class="col" width="200" height="200">
          Ripeness:  <div id="label"></div>
        </div>
      </div>
    </div>
  </div>

 
  <div id="errorMsg"></div>
</body>

</html>
